<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>RAG Q&A</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 20px; }
    .row { display: flex; gap: 16px; }
    .col { flex: 1; }
    .box { border: 1px solid #ddd; padding: 12px; border-radius: 8px; }
    #dropzone { border: 2px dashed #999; padding: 24px; text-align: center; border-radius: 8px; color: #666; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 6px 8px; text-align: left; font-size: 14px; }
    .muted { color: #777; font-size: 12px; }
    .answer { white-space: pre-wrap; }
    details { margin: 6px 0; }
    code { background: #f6f8fa; padding: 1px 4px; border-radius: 4px; }
  </style>
  <script>
    async function refreshDocuments() {
      const res = await fetch('/documents');
      const docs = await res.json();
      const tbody = document.querySelector('#docs tbody');
      tbody.innerHTML = '';
      for (const d of docs) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${d.filename}</td><td>${(d.size_bytes/1024).toFixed(1)} KB</td><td>${d.status}</td>`;
        tbody.appendChild(tr);
      }
    }

    async function uploadFiles(files) {
      const fd = new FormData();
      for (const f of files) fd.append('files', f);
      const res = await fetch('/upload', { method: 'POST', body: fd });
      if (!res.ok) { alert('Upload failed'); return; }
      await refreshDocuments();
    }

    function setupDropzone() {
      const dz = document.getElementById('dropzone');
      dz.addEventListener('dragover', e => { e.preventDefault(); dz.style.background = '#fafafa'; });
      dz.addEventListener('dragleave', e => { dz.style.background = 'transparent'; });
      dz.addEventListener('drop', e => { e.preventDefault(); dz.style.background = 'transparent'; uploadFiles(e.dataTransfer.files); });
    }

    async function startProcess() {
      const fd = new FormData();
      const res = await fetch('/process', { method: 'POST', body: fd });
      const j = await res.json();
      pollStatus(j.job_id);
    }

    async function pollStatus(jobId) {
      const statusEl = document.getElementById('status');
      let done = false;
      while (!done) {
        const res = await fetch(`/status?job_id=${jobId}`);
        if (!res.ok) break;
        const j = await res.json();
        statusEl.textContent = `state=${j.state} processed=${j.processed_docs.length}/${j.queued_docs.length} embedded=${j.embedded_chunks}`;
        if (j.state === 'done' || j.state === 'error') done = true;
        await refreshDocuments();
        if (!done) await new Promise(r => setTimeout(r, 1000));
      }
    }

    async function submitAsk(ev) {
      ev.preventDefault();
      const query = document.getElementById('q').value.trim();
      const res = await fetch('/ask', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query }) });
      const j = await res.json();
      document.getElementById('answer').textContent = j.answer;
      const cits = document.getElementById('citations');
      cits.innerHTML = '';
      for (const c of j.citations) {
        const tag = `${c.filename}#${c.chunk_id}` + (c.page ? ` (p. ${c.page})` : '');
        const dt = document.createElement('details');
        dt.innerHTML = `<summary>${tag}</summary><div class="muted" id="c_${c.chunk_id}">Loading...</div>`;
        dt.addEventListener('toggle', async () => {
          if (dt.open) {
            const match = j.retrieved.find(x => x.filename === c.filename && x.chunk_id === c.chunk_id);
            const docId = match ? match.document_id : '';
            const r = await fetch(`/chunk?document_id=${encodeURIComponent(docId)}&chunk_id=${c.chunk_id}`);
            const d = await r.json();
            dt.querySelector('div').textContent = d.text;
          }
        }, { once: true });
        cits.appendChild(dt);
      }
      const panel = document.getElementById('topk');
      panel.innerHTML = '';
      for (const r of j.retrieved) {
        const p = document.createElement('div');
        const tag = `${r.filename}#${r.chunk_id}` + (r.page ? ` (p. ${r.page})` : '');
        p.innerHTML = `<strong>${tag}</strong> <span class="muted">score=${r.score.toFixed(3)}</span><div class="muted">${r.text}</div>`;
        panel.appendChild(p);
      }
    }

    window.addEventListener('DOMContentLoaded', () => { setupDropzone(); refreshDocuments(); document.getElementById('askform').addEventListener('submit', submitAsk); });
  </script>
</head>
<body>
  <h2>RAG Q&A</h2>

  <div class="row">
    <div class="col">
      <div class="box">
        <div id="dropzone">Drag & drop files here (PDF, DOCX, TXT, MD) or
          <input type="file" id="file" multiple accept=".pdf,.docx,.txt,.md" onchange="uploadFiles(this.files)"/></div>
        <button onclick="startProcess()">Process files</button>
        <div class="muted" id="status"></div>
      </div>
      <div class="box" style="margin-top:12px;">
        <h3>Documents</h3>
        <table id="docs">
          <thead><tr><th>Name</th><th>Size</th><th>Status</th></tr></thead>
          <tbody>
          {% for d in documents %}
          <tr><td>{{ d.filename }}</td><td>{{ '%.1f'|format(d.size_bytes/1024.0) }} KB</td><td>{{ d.status }}</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="col">
      <div class="box">
        <form id="askform">
          <input id="q" placeholder="Ask your questionâ€¦" style="width:100%; padding:8px;" />
          <button type="submit" style="margin-top:8px;">Ask</button>
        </form>
        <div class="answer" id="answer" style="margin-top:10px;"></div>
        <div id="citations" style="margin-top:10px;"></div>
      </div>
      <div class="box" style="margin-top:12px;">
        <h3>Top-k Retrieved</h3>
        <div id="topk"></div>
      </div>
    </div>
  </div>
</body>
</html>